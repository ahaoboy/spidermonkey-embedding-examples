name: Spidermonkey


permissions:
  contents: write

on:
  push:
    branches:
      - "main"
    tags:
      - v*
  pull_request:

env:
  SHELL: /bin/bash
  # ccache
  CCACHE: ccache
  # use clang/lld
  CXX: clang++
  CC: clang
  LDFLAGS: -fuse-ld=lld
  LD_LIBRARY_PATH: /usr/local/lib

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Install deps
      run: |
        sudo apt install ccache llvm clang lld meson ninja-build -y
    - uses: actions-rs/toolchain@v1
      with:
          profile: minimal
          toolchain: stable
          override: true
          default: true
    - name: Get SM pkg
      run: ./tools/get_sm.sh
    - name: ccache cache files
      uses: actions/cache@v1.1.0
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-${{ hashFiles('**/mozjs.tar.xz') }}
    - name: Build SpiderMonkey
      run: |
        mkdir -p /tmp/mozjs
        tar -xf mozjs.tar.xz -C /tmp/mozjs
        cd /tmp/mozjs
        cd $(ls -d */|head -n 1)
        cd js/src
        bash $GITHUB_WORKSPACE/tools/generic_lib.sh $GITHUB_WORKSPACE/meson.build
        mkdir _build
        cd _build
        ../configure --disable-jemalloc --with-system-zlib \
            --with-intl-api --enable-debug --enable-optimize
        ccache -z
        make
        sudo make install
        ccache -s

        cd ..
        cp -r ./_build /tmp/mozjz_build

        sudo apt install tree -y

        cd ./_build /tmp/mozjz_build

        tree > /tmp/tree.txt

        rm -rf /tmp/mozjz_build/x86_64-unknown-linux-gnu
        rm -rf /tmp/mozjz_build/debug

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: spidermonkey-x86_64-unknown-linux-gnu
        path: /tmp/mozjz_build,/tmp/tree.txt